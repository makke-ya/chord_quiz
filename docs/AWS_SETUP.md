# AWS環境セットアップ手順

クイズの結果をクラウド（AWS）に保存し、管理者ダッシュボードで閲覧するための設定手順です。GitHub Pages等で公開する場合のセキュリティ設定も含みます。

## 1. DynamoDBの作成（データベース）

1. AWSコンソールで [DynamoDB](https://console.aws.amazon.com/dynamodb/) を開きます。
2. 「テーブルの作成」をクリックします。
3. **テーブル名**: `ChordQuizResults` (または `ChordQuizDB` ※Lambdaコードと合わせる)
4. **パーティションキー**: `userId` (文字列)
5. **ソートキー**: `timestamp` (文字列)
6. その他の設定はデフォルトのまま「テーブルの作成」をクリックします。

## 2. Lambda関数の作成（プログラム）

1. AWSコンソールで [Lambda](https://console.aws.amazon.com/lambda/) を開きます。
2. 「関数の作成」をクリックします。
3. **一から作成** を選択。
4. **関数名**: `ChordQuizResultHandler` (任意)
5. **ランタイム**: `Python 3.12` (または最新)
6. 作成後、「コード」タブでデフォルトのコードを削除し、ローカルの `backend/lambda_function.py` の内容をコピー＆ペーストします。
7. 「Deploy」をクリックして保存します。

### 環境変数の設定 (重要)
コード内にパスワードを直接書かないために、環境変数を使用します。

1. Lambdaの「設定」タブ → 「環境変数」を開きます。
2. 「編集」をクリックし、以下の変数を追加します。
   - **キー**: `ADMIN_KEY`
   - **値**: (任意の管理者用パスワード ※例: `kanasana123`)
3. 「保存」します。

## 3. 権限の設定（IAM）

LambdaがDynamoDBにアクセスできるようにします。

1. Lambda関数の「設定」タブ → 「アクセス権限」を開きます。
2. 「実行ロール」のリンクをクリックしてIAMコンソールを開きます。
3. 「許可を追加」→「ポリシーをアタッチ」で `AmazonDynamoDBFullAccess` を追加します。

## 4. API Gatewayの作成（公開用URL）

1. AWSコンソールで [API Gateway](https://console.aws.amazon.com/apigateway/) を開きます。
2. **HTTP API** を選択して「構築」。
3. **統合を追加**: 作成したLambda関数 (`ChordQuizResultHandler`) を指定。
4. **API名**: `ChordQuizAPI` (任意)
5. ルートの設定:
   - メソッド: `ANY` (または `GET`, `POST`, `OPTIONS` を個別に設定)
   - リソースパス: `/result`
6. 作成完了後、**APIエンドポイントURL** を控えておきます。

## 5. アプリへの反映 (config.js)

1. ローカルの `static/config.js` を開きます（無ければ `config.sample.js` から作成）。
2. `API_ENDPOINT` に、上記で作成したURLを入力します。
   ```javascript
   API_ENDPOINT: 'https://xxxx.execute-api.ap-northeast-1.amazonaws.com/result'
   ```

## 6. セキュリティ設定 (GitHub Pages公開用)

公開サーバーに配置する場合、以下の設定を行ってください。

### A. CORS設定 (ドメイン制限)
1. API Gatewayのサイドメニュー「CORS」を開く。
2. **Access-Control-Allow-Origin**: GitHub PagesのURLのみを指定 (例: `https://yourname.github.io`)
   - ※末尾に `/` をつけないこと
   - ※まだテスト中なら `*` でも可
3. **Methods**: `GET, POST, OPTIONS`
4. **Headers**: `content-type`
5. 保存します。

### B. スロットリング (連打対策)
1. サイドメニュー「ステージ」→ `$default` (または作成したステージ) を選択。
2. 「ルート設定」タブ等はデフォルトのままでOKですが、「編集」から「スロットリング」を有効化することをお勧めします。
   - **レート**: `10` (1秒あたり10リクエスト)
   - **バースト**: `20`
   - ※これで攻撃を受けてもAWSの高額請求を防げます。


## 7. AWS S3へのデプロイ（静的サイトホスティング）

AWS S3を使用すると、この静的サイトをインターネット上に公開できます。

### 前提条件: AWS CLIのインストール

まだインストールしていない場合は、公式サイトからAWS CLIをインストールしてください。
https://aws.amazon.com/jp/cli/

### 手順1: IAMユーザーとアクセスキーの作成

1. [AWSマネジメントコンソール](https://console.aws.amazon.com/)にログインします。
2. 検索バーで「IAM」を検索し、IAMダッシュボードを開きます。
3. 左メニューから「ユーザー」→「ユーザーの作成」をクリックします。
4. ユーザー名（例: `deploy-user`）を入力します。
5. 「許可のオプション」で「ポリシーを直接アタッチする」を選択します。
6. リストから `AmazonS3FullAccess` を検索してチェックを入れます（本番環境ではより制限された権限が推奨されますが、手始めにはこれで十分です）。
7. ユーザーを作成後、そのユーザーの詳細画面を開きます。
8. 「セキュリティ認証情報」タブ → 「アクセスキー」セクション → 「アクセスキーを作成」をクリックします。
9. 「CLI (コマンドラインインターフェイス)」を選択し、作成します。
10. 表示される **アクセスキー** と **シークレットアクセスキー** をメモします（この画面を閉じると二度と表示されません）。

### 手順2: ローカル環境の設定

ターミナル（PowerShellやコマンドプロンプト）を開き、以下のコマンドを実行します。

```bash
aws configure
```

プロンプトに従って入力します：
- `AWS Access Key ID`: 手順1で取得したアクセスキー
- `AWS Secret Access Key`: 手順1で取得したシークレットキー
- `Default region name`: `ap-northeast-1` （東京リージョンを使う場合）
- `Default output format`: `json` (そのままEnter)

### 手順3: S3バケットの作成

1. AWSコンソールのS3を開き、「バケットを作成」をクリックします。
2. バケット名を入力します（世界で一意である必要があります。例: `my-chord-quiz-2025`）。
3. 「パブリックアクセスのブロック」設定で、**「パブリックアクセスをすべて ブロック」のチェックを外します**（静的サイトとして公開するため）。
    - 警告チェックボックスにチェックを入れます。
4. バケットを作成します。
5. 作成したバケットを開き、「プロパティ」タブ → 「静的ウェブサイトホスティング」を編集し、「有効」にします。
    - インデックスドキュメント: `index.html`
6. 「アクセス許可」タブ → 「バケットポリシー」を編集し、以下を入力します（`YOUR_BUCKET_NAME`を自分のバケット名に書き換えてください）。

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::YOUR_BUCKET_NAME/*"
        }
    ]
}
```

### 手順4: デプロイ（アップロード）

サイトのルートディレクトリで以下のコマンドを実行します。これにより、変更されたファイルだけが自動的にアップロードされます。

```bash
# バケット名は自分のものに置き換えてください
./scripts/aws_sync.sh
```

完了後、S3の「プロパティ」タブにある「バケットウェブサイトエンドポイント」のURLにアクセスすると、サイトが表示されます。

## 8. CloudFrontの導入（HTTPS化・高速化）

AWS CloudFront（CDN）を使うと、**HTTPS (SSL)** での配信が可能になり、世界中のキャッシュサーバーから高速に配信されます。

1. AWSコンソールで [CloudFront](https://console.aws.amazon.com/cloudfront/) を開きます。
2. 「ディストリビューションを作成」をクリックします。
3. **オリジンドメイン**:
    - **ここが重要です！**: プルダウンから選ぶのではなく、**手順3-5で確認した「S3バケットウェブサイトエンドポイント」のURL**（`http://...s3-website...`）をコピーして貼り付けます。
    - ※プルダウンからバケットを選ぶと、REST APIとして扱われ、`index.html` の自動補完が効かなくなる場合があります。
4. **デフォルトのキャッシュビヘイビア**:
    - **ビューワープロトコルポリシー**: `Redirect HTTP to HTTPS`（HTTPをHTTPSにリダイレクト）を選択。
    - **許可されたHTTPメソッド**: `GET, HEAD`（デフォルトのまま）
5. **WAF**: 「セキュリティ保護を有効にしない」（学習用なのでコスト節約）
6. 「ディストリビューションを作成」をクリックします。
7. デプロイが始まります（数分かかります）。
8. ステータスが「有効」になったら、**ディストリビューションドメイン名**（`https://xxxxxx.cloudfront.net`）にアクセスして、サイトが表示されるか確認します。

